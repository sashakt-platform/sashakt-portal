<script lang="ts">
	import Label from '$lib/components/ui/label/label.svelte';
	import X from '@lucide/svelte/icons/x';
	import Info from '@lucide/svelte/icons/info';
	import { superForm, fileProxy } from 'sveltekit-superforms';
	import { zodClient } from 'sveltekit-superforms/adapters';
	import { schema } from './schema.js';
	import Button from '$lib/components/ui/button/button.svelte';
	import BulkTemplate from '$lib/components/Bulk-Upload-Question-Template.csv?url';
	import * as Dialog from '$lib/components/ui/dialog/index.js';

	let { data } = $props();
	const { form, enhance, submit, message } = superForm(data.form, {
		validators: zodClient(schema),
		dataType: 'json',
		onSubmit: () => {
			$form.user_id = data.user.id;
		}
	});

	const file = fileProxy(form, 'file');
</script>

<Dialog.Root open={$message}>
	<Dialog.Content class="sm:max-w-[425px]">
		<Dialog.Header>
			<Dialog.Title>Question Uploading Completed</Dialog.Title>
			<Dialog.Description>
				<div class="text-lg">{$message}</div>
			</Dialog.Description>
		</Dialog.Header>
	</Dialog.Content>
</Dialog.Root>
<div class="mx-10 flex flex-col gap-20 sm:w-[80%]">
	<div class="mt-10 flex flex-row">
		<div class="align-left flex flex-col">
			<span class="flex flex-row">
				<h2
					class="mr-2 w-fit scroll-m-20 pb-2 text-3xl font-semibold tracking-tight transition-colors first:mt-0"
				>
					Import questions
				</h2>
				<Info class="my-auto w-4 align-middle text-xs text-gray-600" />
			</span>
			<Label class="my-auto align-middle text-sm font-extralight"
				>Upload a .csv file to import questions to your question bank</Label
			>
		</div>
		<div class="ml-auto">
			<Button variant="outline" class="text-primary border-primary cursor-pointer bg-transparent"
				><a href={BulkTemplate} download="template.csv">Download Template</a></Button
			>
		</div>
	</div>

	<div class="flex flex-row justify-between">
		<div class="mr-4 h-fit w-1/4 rounded-xl bg-white p-6 shadow-lg">
			<p class="mb-4 text-2xl font-semibold" style="color:#0369A1">Instructions</p>
			<ol class="list-inside list-decimal text-sm" style="color: #525252;">
				<li class="mb-4">
					Download the CSV template or upload your own with appropriate tags & details.
				</li>
				<li class="mb-4">
					Add questions as per the template provided with all tags included & upload the .csv files.
				</li>
				<li class="mb-4">
					You can edit and update the imported questions after uploading the .csv files.
				</li>
			</ol>
		</div>
		<div class="w-3/4 bg-white shadow-lg">
			<form method="POST" enctype="multipart/form-data" use:enhance>
				<input type="file" hidden name="file" bind:files={$file} accept=".csv" />

				<div class="flex flex-col px-6">
					<div
						class="my-6 cursor-pointer items-center rounded-xl border-2 border-dotted border-blue-400 py-6 text-center"
						onclick={() => document.querySelector('input[type=file]').click()}
						onkeydown={(e) =>
							e.key === 'Enter' && document.querySelector('input[type=file]').click()}
						role="button"
						tabindex="0"
					>
						<div class="flex items-center justify-center text-center">
							<svg
								width="86"
								height="86"
								viewBox="0 0 86 86"
								fill="none"
								xmlns="http://www.w3.org/2000/svg"
							>
								<circle cx="43" cy="43" r="43" fill="#F0F9FF" />
								<path
									fill-rule="evenodd"
									clip-rule="evenodd"
									d="M57 35.9955V54.986C57 56.0463 56.5786 57.0632 55.8284 57.813C55.0783 58.5628 54.0609 58.984 53 58.984H51V56.985H53C53.5304 56.985 54.0391 56.7744 54.4142 56.3995C54.7893 56.0246 55 55.5162 55 54.986V35.9955H51C50.2044 35.9955 49.4413 35.6796 48.8787 35.1173C48.3161 34.5549 48 33.7923 48 32.997V28.999H37C36.4696 28.999 35.9609 29.2096 35.5858 29.5845C35.2107 29.9594 35 30.4678 35 30.998V48.989H33V30.998C33 29.9377 33.4214 28.9208 34.1716 28.171C34.9217 27.4212 35.9391 27 37 27H48L57 35.9955ZM36.034 56.6672C36.0454 56.9821 36.1227 57.2912 36.2608 57.5746C36.399 57.8579 36.5949 58.1092 36.836 58.3123C37.096 58.5282 37.4147 58.6962 37.792 58.8161C38.1707 58.9374 38.614 58.998 39.122 58.998C39.798 58.998 40.3707 58.8927 40.84 58.6822C41.312 58.4716 41.6713 58.1784 41.918 57.8026C42.1673 57.4241 42.292 56.987 42.292 56.4913C42.292 56.0435 42.2027 55.6703 42.024 55.3718C41.841 55.0722 41.5823 54.8261 41.274 54.6582C40.9201 54.4618 40.5384 54.3203 40.142 54.2384L38.9 53.9505C38.6078 53.8948 38.3318 53.7746 38.092 53.5987C38.0007 53.5284 37.9272 53.4377 37.8772 53.3339C37.8272 53.2302 37.8021 53.1162 37.804 53.001C37.804 52.6892 37.9273 52.4333 38.174 52.2334C38.4247 52.0308 38.766 51.9295 39.198 51.9295C39.4833 51.9295 39.73 51.9748 39.938 52.0655C40.1305 52.1416 40.3 52.2663 40.43 52.4273C40.5531 52.5757 40.6358 52.7533 40.67 52.943H42.17C42.1442 52.5361 42.0057 52.1444 41.77 51.8116C41.518 51.4521 41.1721 51.1686 40.77 50.992C40.2791 50.7758 39.7462 50.672 39.21 50.6882C38.6247 50.6882 38.1073 50.7881 37.658 50.988C37.2087 51.1866 36.8573 51.4671 36.604 51.8296C36.3507 52.1934 36.224 52.6192 36.224 53.1069C36.224 53.5094 36.3053 53.8586 36.468 54.1544C36.6333 54.4516 36.868 54.6962 37.172 54.8881C37.476 55.0786 37.8353 55.2206 38.25 55.3138L39.486 55.6017C39.8993 55.699 40.208 55.8276 40.412 55.9875C40.5113 56.0638 40.5907 56.1628 40.6437 56.2762C40.6966 56.3897 40.7214 56.5141 40.716 56.6392C40.7205 56.8453 40.6611 57.0478 40.546 57.2189C40.4171 57.3943 40.2399 57.5284 40.036 57.6047C39.8133 57.698 39.538 57.7446 39.21 57.7446C38.9767 57.7446 38.7633 57.718 38.57 57.6647C38.3927 57.6171 38.2249 57.5393 38.074 57.4348C37.941 57.3485 37.8271 57.2358 37.7394 57.1038C37.6517 56.9718 37.592 56.8232 37.564 56.6672H36.034ZM30.612 54.3723C30.612 53.8752 30.68 53.4534 30.816 53.1069C30.9348 52.7877 31.1449 52.5104 31.42 52.3093C31.6998 52.1201 32.0323 52.0242 32.37 52.0355C32.67 52.0355 32.9353 52.1001 33.166 52.2294C33.3914 52.3498 33.5795 52.5295 33.71 52.7491C33.8494 52.9803 33.9317 53.2414 33.95 53.5107H35.48V53.3668C35.4667 52.9986 35.377 52.6372 35.2166 52.3054C35.0561 51.9737 34.8285 51.6789 34.548 51.4398C34.2619 51.1946 33.9293 51.0097 33.57 50.8961C33.1801 50.7626 32.7701 50.697 32.358 50.7022C31.646 50.7022 31.0387 50.8507 30.536 51.1479C30.036 51.4438 29.6547 51.8649 29.392 52.4113C29.132 52.9577 29.0013 53.61 29 54.3683V55.3638C29 56.1208 29.1287 56.7711 29.386 57.3148C29.6487 57.8572 30.03 58.2744 30.53 58.5662C31.03 58.8554 31.6393 59 32.358 59C32.9433 59 33.4667 58.8907 33.928 58.6722C34.3893 58.4536 34.756 58.1511 35.028 57.7646C35.3039 57.3677 35.4607 56.9002 35.48 56.4173V56.2654H33.952C33.9331 56.5227 33.8521 56.7717 33.716 56.991C33.5827 57.2033 33.3948 57.3759 33.172 57.4908C32.9216 57.6097 32.6472 57.6692 32.37 57.6647C32.0322 57.6736 31.6993 57.5818 31.414 57.4008C31.1399 57.2062 30.9313 56.9329 30.816 56.6172C30.6698 56.2159 30.6006 55.7907 30.612 55.3638V54.3723ZM47.09 58.8461H45.184L42.508 50.8521H44.342L46.134 57.1249H46.21L47.986 50.8521H49.744L47.09 58.8461Z"
									fill="#0369A1"
								/>
							</svg>
						</div>

						<p class="text-lg font-bold text-blue-400" style="color:#0369A1">
							Click to upload Questions
						</p>
						<p class="text-sm text-gray-400">CSV | File Size Limit:20MB</p>
					</div>
					{#if $form.file}
						<div class="flex flex-row gap-2 bg-[#F0F9FF] p-4">
							<svg
								class="m-1"
								width="52"
								height="60"
								viewBox="0 0 52 60"
								fill="none"
								xmlns="http://www.w3.org/2000/svg"
							>
								<rect width="52" height="60" rx="6" fill="white" />
								<path
									fill-rule="evenodd"
									clip-rule="evenodd"
									d="M37.75 24.3088V39.7386C37.75 40.6002 37.4076 41.4264 36.7981 42.0356C36.1886 42.6448 35.362 42.987 34.5 42.987H32.875V41.3628H34.5C34.931 41.3628 35.3443 41.1917 35.649 40.8871C35.9538 40.5825 36.125 40.1694 36.125 39.7386V24.3088H32.875C32.2285 24.3088 31.6085 24.0522 31.1514 23.5953C30.6943 23.1384 30.4375 22.5187 30.4375 21.8726V18.6242H21.5C21.069 18.6242 20.6557 18.7953 20.351 19.0999C20.0462 19.4045 19.875 19.8176 19.875 20.2484V34.8661H18.25V20.2484C18.25 19.3869 18.5924 18.5606 19.2019 17.9514C19.8114 17.3422 20.638 17 21.5 17H30.4375L37.75 24.3088ZM20.7151 41.1046C20.7244 41.3605 20.7872 41.6116 20.8994 41.8418C21.0117 42.0721 21.1708 42.2762 21.3667 42.4413C21.578 42.6167 21.8369 42.7531 22.1435 42.8506C22.4512 42.9491 22.8114 42.9984 23.2241 42.9984C23.7734 42.9984 24.2387 42.9128 24.62 42.7418C25.0035 42.5707 25.2955 42.3325 25.4959 42.0271C25.6985 41.7196 25.7997 41.3644 25.7997 40.9616C25.7997 40.5978 25.7272 40.2946 25.582 40.0521C25.4333 39.8087 25.2232 39.6087 24.9726 39.4723C24.6851 39.3127 24.375 39.1977 24.0529 39.1312L23.0437 38.8973C22.8064 38.852 22.5821 38.7543 22.3872 38.6114C22.3131 38.5543 22.2533 38.4806 22.2127 38.3963C22.1721 38.312 22.1517 38.2194 22.1532 38.1258C22.1532 37.8724 22.2535 37.6645 22.4539 37.5021C22.6575 37.3375 22.9349 37.2552 23.2859 37.2552C23.5177 37.2552 23.7181 37.2921 23.8871 37.3657C24.0435 37.4276 24.1812 37.5289 24.2869 37.6597C24.3869 37.7802 24.4541 37.9246 24.4819 38.0787H25.7006C25.6797 37.7481 25.5671 37.4298 25.3756 37.1594C25.1709 36.8673 24.8898 36.637 24.5631 36.4935C24.1643 36.3179 23.7312 36.2335 23.2956 36.2466C22.82 36.2466 22.3997 36.3278 22.0346 36.4903C21.6695 36.6516 21.3841 36.8795 21.1783 37.174C20.9724 37.4696 20.8695 37.8156 20.8695 38.2119C20.8695 38.5389 20.9356 38.8226 21.0677 39.063C21.2021 39.3044 21.3927 39.5031 21.6398 39.659C21.8867 39.8139 22.1787 39.9292 22.5156 40.005L23.5199 40.2389C23.8557 40.3179 24.1065 40.4224 24.2723 40.5524C24.3529 40.6143 24.4175 40.6948 24.4605 40.7869C24.5035 40.8791 24.5236 40.9802 24.5192 41.0818C24.5229 41.2493 24.4747 41.4138 24.3811 41.5528C24.2764 41.6954 24.1324 41.8043 23.9668 41.8663C23.7858 41.9421 23.5621 41.98 23.2956 41.98C23.106 41.98 22.9327 41.9584 22.7756 41.915C22.6316 41.8764 22.4952 41.8132 22.3726 41.7283C22.2646 41.6581 22.1721 41.5666 22.1008 41.4593C22.0295 41.3521 21.981 41.2313 21.9583 41.1046H20.7151ZM16.3097 39.24C16.3097 38.8361 16.365 38.4934 16.4755 38.2119C16.5721 37.9525 16.7427 37.7272 16.9663 37.5638C17.1936 37.4101 17.4638 37.3322 17.7381 37.3413C17.9819 37.3413 18.1975 37.3938 18.3849 37.4989C18.568 37.5967 18.7209 37.7427 18.8269 37.9212C18.9401 38.109 19.007 38.3212 19.0219 38.54H20.265V38.423C20.2542 38.1239 20.1813 37.8302 20.051 37.5607C19.9206 37.2911 19.7356 37.0516 19.5078 36.8573C19.2753 36.6581 19.005 36.5079 18.7131 36.4155C18.3963 36.3071 18.0632 36.2538 17.7284 36.258C17.1499 36.258 16.6564 36.3787 16.248 36.6202C15.8418 36.8606 15.5319 37.2027 15.3185 37.6467C15.1072 38.0906 15.0011 38.6206 15 39.2368V40.0456C15 40.6606 15.1045 41.189 15.3136 41.6308C15.527 42.0715 15.8369 42.4104 16.2431 42.6476C16.6494 42.8825 17.1445 43 17.7284 43C18.204 43 18.6292 42.9112 19.004 42.7336C19.3788 42.5561 19.6767 42.3103 19.8977 41.9963C20.1219 41.6737 20.2493 41.294 20.265 40.9015V40.7781H19.0235C19.0081 40.9872 18.9423 41.1895 18.8318 41.3677C18.7235 41.5402 18.5708 41.6804 18.3898 41.7737C18.1863 41.8704 17.9633 41.9187 17.7381 41.915C17.4636 41.9223 17.1932 41.8477 16.9614 41.7007C16.7386 41.5425 16.5692 41.3205 16.4755 41.064C16.3567 40.7379 16.3005 40.3925 16.3097 40.0456V39.24ZM29.6981 42.8749H28.1495L25.9753 36.3798H27.4654L28.9214 41.4765H28.9831L30.4261 36.3798H31.8545L29.6981 42.8749Z"
									fill="#0369A1"
								/>
							</svg>
							<div class="my-auto flex-row">
								<p class="font-bold">{$form.file?.name}</p>
								<p class="text-sm font-light">
									{#if $form.file?.size}
										{$form.file.size < 1024 * 1024
											? `${($form.file.size / 1024).toFixed(2)} KB`
											: `${($form.file.size / (1024 * 1024)).toFixed(2)} MB`}
									{/if}
								</p>
							</div>
							<X
								class="my-auto ml-auto cursor-pointer rounded-full bg-gray-100 p-1"
								onclick={() => {
									$file = undefined;
								}}
							/>
						</div>
					{/if}
					<div class="m-4 ml-auto space-x-3">
						<Button
							variant="outline"
							onclick={() => {
								$file = undefined;
							}}>Discard</Button
						>
						<Button
							disabled={!$form.file}
							onclick={() => {
								submit();
							}}>Import</Button
						>
					</div>
				</div>
			</form>
		</div>
	</div>
</div>
